import React, { useState, useRef, useEffect } from 'react';
import { 
  Leaf, 
  Upload, 
  BarChart3, 
  PieChart as PieIcon, 
  Info, 
  RefreshCw, 
  AlertCircle,
  CheckCircle2,
  Activity
} from 'lucide-react';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement,
} from 'chart.js';
import { Bar, Pie } from 'react-chartjs-2';

// Register ChartJS components
ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement
);

const App = () => {
  const [image, setImage] = useState(null);
  const [imagePreview, setImagePreview] = useState(null);
  const [results, setResults] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [error, setError] = useState(null);
  const canvasRef = useRef(null);

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        setError("Please upload a valid image file.");
        return;
      }
      setError(null);
      setImage(file);
      const reader = new FileReader();
      reader.onload = (event) => {
        setImagePreview(event.target.result);
        setResults(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const analyzePlantHealth = () => {
    if (!imagePreview) return;
    setIsProcessing(true);
    
    const img = new Image();
    img.src = imagePreview;
    
    img.onload = () => {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      
      // Fixed size for analysis (matches the 200x200 logic in the original code)
      const size = 200;
      canvas.width = size;
      canvas.height = size;
      
      ctx.drawImage(img, 0, 0, size, size);
      const imageData = ctx.getImageData(0, 0, size, size);
      const data = imageData.data;
      
      let greenCount = 0;
      let yellowCount = 0;
      let totalPixels = size * size;

      // Iterate through RGBA data
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        // Green logic: G > R and G > B
        if (g > r && g > b) {
          greenCount++;
        } 
        // Yellow logic: R > G and G > B (approx yellow/brown stress)
        else if (r > g && g > b) {
          yellowCount++;
        }
      }

      const greenPercent = (greenCount / totalPixels) * 100;
      const yellowPercent = (yellowCount / totalPixels) * 100;
      const otherPercent = 100 - (greenPercent + yellowPercent);

      setTimeout(() => {
        setResults({
          green: greenPercent,
          yellow: yellowPercent,
          other: otherPercent,
          status: greenPercent > yellowPercent ? 'Healthy' : 'Stressed'
        });
        setIsProcessing(false);
      }, 600); // Small delay for better UX
    };
  };

  const barData = results ? {
    labels: ['Green (Healthy)', 'Yellow (Stressed)', 'Other'],
    datasets: [
      {
        label: 'Percentage (%)',
        data: [results.green, results.yellow, results.other],
        backgroundColor: [
          'rgba(34, 197, 94, 0.7)',
          'rgba(234, 179, 8, 0.7)',
          'rgba(156, 163, 175, 0.7)',
        ],
        borderColor: [
          'rgb(34, 197, 94)',
          'rgb(234, 179, 8)',
          'rgb(156, 163, 175)',
        ],
        borderWidth: 1,
      },
    ],
  } : null;

  const pieData = results ? {
    labels: ['Healthy Area', 'Stressed Area'],
    datasets: [
      {
        data: [results.green, results.yellow],
        backgroundColor: [
          'rgba(34, 197, 94, 0.7)',
          'rgba(239, 68, 68, 0.7)',
        ],
        borderColor: [
          'rgb(34, 197, 94)',
          'rgb(239, 68, 68)',
        ],
        borderWidth: 1,
      },
    ],
  } : null;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans p-4 md:p-8">
      {/* Header */}
      <header className="max-w-5xl mx-auto mb-8 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="bg-green-600 p-2 rounded-lg shadow-lg shadow-green-200">
            <Leaf className="text-white w-8 h-8" />
          </div>
          <div>
            <h1 className="text-2xl font-bold tracking-tight">PlantPulse AI</h1>
            <p className="text-slate-500 text-sm">Leaf Health Analysis Tool</p>
          </div>
        </div>
        <div className="hidden md:flex items-center gap-2 text-slate-400 text-sm italic">
          <Info size={16} />
          <span>Analyzing pixels for chlorophyll vs. xanthophyll markers</span>
        </div>
      </header>

      <main className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        {/* Left Column: Upload & Preview */}
        <div className="lg:col-span-5 space-y-6">
          <section className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <Upload size={20} className="text-blue-500" />
              Upload Leaf Image
            </h2>
            
            <div 
              className={`relative border-2 border-dashed rounded-xl p-8 transition-all flex flex-col items-center justify-center text-center
                ${imagePreview ? 'border-green-300 bg-green-50' : 'border-slate-300 hover:border-blue-400 bg-slate-50'}`}
            >
              <input
                type="file"
                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                onChange={handleImageUpload}
                accept="image/*"
              />
              
              {!imagePreview ? (
                <>
                  <div className="bg-white p-3 rounded-full shadow-md mb-3">
                    <Upload className="text-slate-400 w-6 h-6" />
                  </div>
                  <p className="font-medium">Click to select or drag and drop</p>
                  <p className="text-xs text-slate-400 mt-1">PNG, JPG, or WEBP (Max 5MB)</p>
                </>
              ) : (
                <div className="relative w-full aspect-square rounded-lg overflow-hidden shadow-inner bg-black flex items-center justify-center">
                  <img src={imagePreview} alt="Leaf preview" className="max-w-full max-h-full object-contain" />
                  <div className="absolute top-2 right-2 flex gap-2">
                     <button 
                      onClick={(e) => { e.preventDefault(); setImagePreview(null); setImage(null); setResults(null); }}
                      className="bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-lg"
                    >
                      <RefreshCw size={14} />
                    </button>
                  </div>
                </div>
              )}
            </div>

            {error && (
              <div className="mt-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm flex items-center gap-2">
                <AlertCircle size={16} />
                {error}
              </div>
            )}

            <button
              onClick={analyzePlantHealth}
              disabled={!imagePreview || isProcessing}
              className={`w-full mt-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg
                ${!imagePreview ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 
                  isProcessing ? 'bg-blue-400 text-white animate-pulse' : 'bg-green-600 text-white hover:bg-green-700 active:scale-95 shadow-green-100'}`}
            >
              {isProcessing ? (
                <><RefreshCw className="animate-spin" size={20} /> Analyzing...</>
              ) : (
                <><Activity size={20} /> Run Diagnosis</>
              )}
            </button>
          </section>

          {/* Hidden canvas for processing */}
          <canvas ref={canvasRef} className="hidden" />

          {/* Educational Note */}
          <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800 space-y-2">
            <h3 className="font-bold flex items-center gap-2">
              <Info size={16} /> How it works
            </h3>
            <p>This tool mimics the Python logic by scanning every pixel. It classifies pixels as "Healthy" if Green is the dominant color, and "Stressed" if Red/Yellow tones dominate.</p>
          </div>
        </div>

        {/* Right Column: Results & Analytics */}
        <div className="lg:col-span-7">
          {!results && !isProcessing && (
            <div className="h-full min-h-[400px] flex flex-col items-center justify-center text-center bg-white border border-dashed border-slate-300 rounded-2xl p-8 opacity-60">
              <BarChart3 size={48} className="text-slate-300 mb-4" />
              <h3 className="text-xl font-medium text-slate-500">Analysis Pending</h3>
              <p className="text-slate-400 max-w-xs mt-2">Upload a photo of a leaf and click "Run Diagnosis" to see the health report.</p>
            </div>
          )}

          {isProcessing && (
            <div className="h-full min-h-[400px] flex flex-col items-center justify-center text-center bg-white rounded-2xl shadow-sm p-8">
              <div className="relative w-24 h-24 mb-6">
                 <div className="absolute inset-0 border-4 border-green-100 rounded-full"></div>
                 <div className="absolute inset-0 border-4 border-green-600 rounded-full border-t-transparent animate-spin"></div>
                 <div className="absolute inset-0 flex items-center justify-center">
                    <Leaf className="text-green-600 w-10 h-10" />
                 </div>
              </div>
              <h3 className="text-xl font-semibold">Processing Pixels...</h3>
              <p className="text-slate-500 mt-2">Scanning leaf tissue for discoloration</p>
            </div>
          )}

          {results && (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
              {/* Summary Card */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-lg font-semibold flex items-center gap-2">
                    <Activity size={20} className="text-green-500" />
                    Diagnosis Summary
                  </h2>
                  <div className={`px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 
                    ${results.status === 'Healthy' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                    {results.status === 'Healthy' ? <CheckCircle2 size={16} /> : <AlertCircle size={16} />}
                    {results.status} Plant
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                  <div className="bg-green-50 p-4 rounded-xl text-center">
                    <p className="text-green-600 text-xs font-bold uppercase tracking-wider mb-1">Green Area</p>
                    <p className="text-2xl font-black text-green-700">{results.green.toFixed(1)}%</p>
                  </div>
                  <div className="bg-yellow-50 p-4 rounded-xl text-center">
                    <p className="text-yellow-600 text-xs font-bold uppercase tracking-wider mb-1">Yellow Area</p>
                    <p className="text-2xl font-black text-yellow-700">{results.yellow.toFixed(1)}%</p>
                  </div>
                  <div className="bg-slate-50 p-4 rounded-xl text-center">
                    <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Other Area</p>
                    <p className="text-2xl font-black text-slate-600">{results.other.toFixed(1)}%</p>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div className="space-y-3">
                    <h3 className="text-sm font-bold text-slate-500 flex items-center gap-2">
                      <BarChart3 size={16} /> Bar Analysis
                    </h3>
                    <div className="h-48">
                      <Bar 
                        data={barData} 
                        options={{ 
                          responsive: true, 
                          maintainAspectRatio: false,
                          plugins: { legend: { display: false } },
                          scales: { y: { beginAtZero: true, max: 100 } }
                        }} 
                      />
                    </div>
                  </div>
                  <div className="space-y-3">
                    <h3 className="text-sm font-bold text-slate-500 flex items-center gap-2">
                      <PieIcon size={16} /> Distribution
                    </h3>
                    <div className="h-48 flex justify-center">
                      <Pie 
                        data={pieData} 
                        options={{ 
                          responsive: true, 
                          maintainAspectRatio: false,
                          plugins: { 
                            legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } 
                          } 
                        }} 
                      />
                    </div>
                  </div>
                </div>
              </div>

              {/* Recommendations */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 className="text-lg font-semibold mb-4">Treatment Insights</h2>
                <div className="space-y-4">
                  {results.yellow > 5 ? (
                    <div className="flex gap-4 p-4 bg-amber-50 rounded-xl border border-amber-100">
                      <div className="bg-amber-500 h-8 w-8 rounded-lg flex items-center justify-center shrink-0">
                        <AlertCircle className="text-white" size={18} />
                      </div>
                      <div>
                        <p className="font-bold text-amber-900">Stress Detected</p>
                        <p className="text-sm text-amber-800">The presence of yellow pigmentation may indicate Nitrogen deficiency, overwatering, or pest damage. Consider testing soil pH and checking leaf undersides.</p>
                      </div>
                    </div>
                  ) : (
                    <div className="flex gap-4 p-4 bg-green-50 rounded-xl border border-green-100">
                      <div className="bg-green-500 h-8 w-8 rounded-lg flex items-center justify-center shrink-0">
                        <CheckCircle2 className="text-white" size={18} />
                      </div>
                      <div>
                        <p className="font-bold text-green-900">Optimal Condition</p>
                        <p className="text-sm text-green-800">Your plant appears largely healthy with significant chlorophyll density. Maintain current watering and light schedules.</p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      </main>

      <footer className="max-w-5xl mx-auto mt-12 pt-8 border-t border-slate-200 text-center text-slate-400 text-sm">
        <p>© 2024 PlantPulse AI Diagnostics • Powered by Computer Vision</p>
      </footer>
    </div>
  );
};

export default App;
